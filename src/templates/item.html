{% extends "base.html" %}
{% block header_breadcrumbs %}
  <div class="header-breadcrumbs">
    <a href="{{ root }}/">Home</a> <span class="sep">&gt;</span> ChinaXiv {{ item.id }}
  </div>
{% endblock %}
{% block content %}
  <article class="paper">
    <div class="paper-layout">
      <div class="paper-main">
        {# Subject classification line, arXiv-style #}
        {% set _subjects = (item.subjects_en if item.subjects_en else (item.subjects if item.subjects else [])) %}
        {% set _source_url = item.source_url or ('https://chinaxiv.org/abs/' ~ item.id) %}
        {# Deduplicate authors #}
        {% set _authors_raw = item.creators_en or item.creators or ['Unknown'] %}
        {% set _authors_seen = {} %}
        {% set _authors_unique = [] %}
        {% for a in _authors_raw %}
          {% if a and a not in _authors_seen %}
            {% set _ = _authors_seen.update({a: true}) %}
            {% set _ = _authors_unique.append(a) %}
          {% endif %}
        {% endfor %}
        {# Format date for display #}
        {% set _date_display = item.date[:10] if item.date and item.date|length >= 10 else (item.date or 'N/A') %}
        {# Minimal clean info block #}
        <div class="paper-title-block">{{ item.title_en }}</div>
        <div class="paper-authors-block">{{ ', '.join(_authors_unique) }}</div>
        <div class="paper-meta-line">
          <span>Submitted {{ _date_display }}</span>
          <span class="meta-sep">|</span>
          <span>ChinaXiv: {{ item.id }}</span>
          {% if _subjects and (_subjects|length) > 0 %}
            <span class="meta-sep">|</span>
            <span>{{ ', '.join(_subjects) }}</span>
          {% endif %}
          {% if item.license and item.license.badge %}
            <span class="meta-sep">|</span>
            <span class="badge">{{ item.license.badge }}</span>
          {% endif %}
          {% if not item._has_full_text %}
            <span class="meta-sep">|</span>
            <span class="badge">Abstract only</span>
          {% endif %}
        </div>

        <h2>Abstract</h2>
        <div class="abstract-blockquote">
          {{ (item.abstract_md or item.abstract_en) | markdown | safe }}
        </div>

        {% if item._has_full_text and item.formatted_body_md %}
          <h2>Full Text</h2>
          <div class="full-text-preview">
            {{ item.formatted_body_md | markdown | safe }}
          </div>
        {% elif item._has_full_text and item.body_en %}
          <h2>Full Text</h2>
          <div class="full-text-preview">
            {% for p in item.body_en %}
              <p>{{ p }}</p>
            {% endfor %}
          </div>
        {% endif %}

        {# Submission history (single entry, we do not have versions) #}
        <div class="submission-history">
          <h2>Submission history</h2>
          <div class="dateline">[v1] {{ _date_display }}</div>
        </div>
      </div>

      <div class="paper-sidebar">
        <div class="sidebar-section">
          <h3>{% if item._has_full_text %}Access Paper{% else %}Access Abstract{% endif %}</h3>
          {% if not item._has_full_text %}
          <div class="banner" role="status">This record includes the abstract only. Full text is not available for this paper.</div>
          {% endif %}
          <ul class="sidebar-actions">
            {% if item._has_full_text %}
            <li><a href="{{ item.id ~ '.pdf' }}" class="sidebar-btn primary" aria-label="Download English translation as PDF">Download PDF (English)</a></li>
            {% endif %}
            {% if item.pdf_url %}
            <li><a href="{{ item.pdf_url }}" class="sidebar-btn" target="_blank" rel="noopener" aria-label="View original PDF on ChinaXiv">Original PDF (Chinese)</a></li>
            {% endif %}
            <li><a href="{{ _source_url }}" class="sidebar-btn" target="_blank" rel="noopener" aria-label="View original record on ChinaXiv">View on ChinaXiv</a></li>
          </ul>
        </div>

        <div class="sidebar-section">
          <h3>Citation</h3>
          <ul class="sidebar-actions">
            <li><a href="#" class="sidebar-btn" onclick="openCitationModal(); return false;" aria-label="Cite this paper">Cite This Paper</a></li>
          </ul>
        </div>

        <div class="sidebar-section">
          <h3>Share</h3>
          <ul class="sidebar-actions">
            <li><a href="#" class="sidebar-btn" onclick="copyLink(); return false;" aria-label="Copy link to clipboard">Copy Link</a></li>
            <li><a href="#" class="sidebar-btn" onclick="bookmarkPaper(); return false;" aria-label="Bookmark this paper">Bookmark</a></li>
          </ul>
        </div>

        <div class="sidebar-section">
          <h3>Feedback</h3>
          <ul class="sidebar-actions">
            <li><a href="#" class="sidebar-btn" onclick="openReportModal(); return false;" aria-label="Report a problem with this paper">Report Problem</a></li>
          </ul>
        </div>

      </div>
    </div>
  </article>

  <!-- Citation Modal -->
  <div id="citation-modal" class="modal" role="dialog" aria-labelledby="citation-modal-title" aria-modal="true">
    <div class="modal-backdrop" onclick="closeCitationModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="citation-modal-title">Cite This Paper</h2>
        <button class="modal-close" onclick="closeCitationModal()" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="citation-format-row">
          <label for="citation-format">Format:</label>
          <select id="citation-format" onchange="updateCitationPreview()">
            <option value="apa">APA 7th</option>
            <option value="mla">MLA 9th</option>
            <option value="chicago">Chicago</option>
            <option value="bibtex">BibTeX</option>
          </select>
        </div>
        <div class="citation-preview" id="citation-preview"></div>
        <button class="btn-copy-citation" onclick="copyCitation()">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <!-- Report Problem Modal -->
  <div id="report-modal" class="modal" role="dialog" aria-labelledby="report-modal-title" aria-modal="true">
    <div class="modal-backdrop" onclick="closeReportModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="report-modal-title">Report a Problem</h2>
        <button class="modal-close" onclick="closeReportModal()" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="report-form">
          <div class="form-group">
            <label for="report-type">Issue Type:</label>
            <select id="report-type" class="report-select">
              <option value="translation">Translation Error</option>
              <option value="figure">Figure Problem</option>
              <option value="site-bug">Site Bug</option>
              <option value="feature">Feature Request</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="report-description">Description:</label>
            <textarea id="report-description" class="report-textarea" rows="5" maxlength="5000" placeholder="Please describe the issue in detail. Include specific text or sections if reporting a translation error." aria-describedby="report-char-count"></textarea>
            <div class="char-counter" id="report-char-count"><span id="report-char-current">0</span> / 5000</div>
          </div>
          <div id="report-error" class="report-error" role="alert" aria-live="polite"></div>
          <div class="form-group report-context">
            <small>We'll automatically include page information to help diagnose the issue.</small>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-submit-report" onclick="submitReport()" id="report-submit-btn">Submit Report</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Paper metadata for citation formatting
    const paperData = {
      id: {{ item.id|tojson }},
      title: {{ item.title_en|tojson }},
      authors: {{ _authors_unique|tojson }},
      year: {{ (item.date[:4] if item.date else 'n.d.')|tojson }},
      date: {{ (item.date or '')|tojson }},
      url: {{ _source_url|tojson }},
      subjects: {{ (item.subjects_en or item.subjects or [])|tojson }}
    };

    // Format author names for APA: "Author1, Author2, & Author3"
    function formatAuthorsAPA(authors) {
      if (!authors || authors.length === 0) return '';
      if (authors.length === 1) return authors[0];
      if (authors.length === 2) return authors.join(' & ');
      return authors.slice(0, -1).join(', ') + ', & ' + authors[authors.length - 1];
    }

    // Format author names for MLA: "Author1, and Author2" or "Author1, et al."
    function formatAuthorsMLA(authors) {
      if (!authors || authors.length === 0) return '';
      if (authors.length <= 2) return authors.join(', and ');
      return authors[0] + ', et al.';
    }

    // Format author names for BibTeX: "Author1 and Author2 and Author3"
    function formatAuthorsBibTeX(authors) {
      if (!authors || authors.length === 0) return '';
      return authors.join(' and ');
    }

    function getCitationAPA() {
      const authors = formatAuthorsAPA(paperData.authors);
      return `${authors} (${paperData.year}). ${paperData.title}. ChinaXiv. ${paperData.url}`;
    }

    function getCitationMLA() {
      const authors = formatAuthorsMLA(paperData.authors);
      return `${authors}. "${paperData.title}." ChinaXiv, ${paperData.year}, ${paperData.id}. ${paperData.url}.`;
    }

    function getCitationChicago() {
      const authors = formatAuthorsAPA(paperData.authors);
      const dateStr = paperData.date ? new Date(paperData.date).toLocaleDateString('en-US', {month: 'long', day: 'numeric'}) : '';
      return `${authors}. ${paperData.year}. "${paperData.title}." Preprint, ChinaXiv${dateStr ? ', ' + dateStr : ''}. ${paperData.url}.`;
    }

    function getCitationBibTeX() {
      const id = paperData.id.replace(/[.-]/g, '_');
      const title = (paperData.title || '').replace(/[{}\\]/g, '\\$&');
      const authors = formatAuthorsBibTeX(paperData.authors).replace(/[{}\\]/g, '\\$&');
      const subject = paperData.subjects.length > 0 ? paperData.subjects[0] : '';

      return `@misc{chinaxiv_${id},
  title={${title}},
  author={${authors}},
  year={${paperData.year}},
  eprint={${paperData.id}},
  archivePrefix={ChinaXiv},
  primaryClass={${subject}},
  url={${paperData.url}}
}`;
    }

    function updateCitationPreview() {
      const format = document.getElementById('citation-format').value;
      const preview = document.getElementById('citation-preview');
      let citation;

      switch(format) {
        case 'apa': citation = getCitationAPA(); break;
        case 'mla': citation = getCitationMLA(); break;
        case 'chicago': citation = getCitationChicago(); break;
        case 'bibtex': citation = getCitationBibTeX(); break;
      }

      preview.textContent = citation;
      if (format === 'bibtex') {
        preview.classList.add('monospace');
      } else {
        preview.classList.remove('monospace');
      }
    }

    function copyCitation() {
      const format = document.getElementById('citation-format').value;
      let citation;

      switch(format) {
        case 'apa': citation = getCitationAPA(); break;
        case 'mla': citation = getCitationMLA(); break;
        case 'chicago': citation = getCitationChicago(); break;
        case 'bibtex': citation = getCitationBibTeX(); break;
      }

      copyToClipboard(citation, 'Citation copied!');
    }

    // Modal functions
    function openCitationModal() {
      const modal = document.getElementById('citation-modal');
      modal.classList.add('open');
      document.body.style.overflow = 'hidden';
      updateCitationPreview();
    }

    function closeCitationModal() {
      const modal = document.getElementById('citation-modal');
      modal.classList.remove('open');
      document.body.style.overflow = '';
    }

    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeCitationModal();
        closeReportModal();
      }
    });

    // Report Problem Modal functions
    let reportModalTrigger = null;  // Track what opened the modal for focus return

    function openReportModal() {
      const modal = document.getElementById('report-modal');
      reportModalTrigger = document.activeElement;
      modal.classList.add('open');
      document.body.style.overflow = 'hidden';
      // Reset form
      document.getElementById('report-type').value = 'translation';
      document.getElementById('report-description').value = '';
      document.getElementById('report-char-current').textContent = '0';
      document.getElementById('report-error').textContent = '';
      document.getElementById('report-submit-btn').disabled = false;
      document.getElementById('report-submit-btn').textContent = 'Submit Report';
      // Focus the first interactive element
      setTimeout(() => document.getElementById('report-type').focus(), 50);
    }

    function closeReportModal() {
      const modal = document.getElementById('report-modal');
      modal.classList.remove('open');
      document.body.style.overflow = '';
      // Return focus to trigger element
      if (reportModalTrigger) {
        reportModalTrigger.focus();
        reportModalTrigger = null;
      }
    }

    // Character counter for description
    document.getElementById('report-description').addEventListener('input', function() {
      document.getElementById('report-char-current').textContent = this.value.length;
    });

    // Focus trap for report modal
    document.getElementById('report-modal').addEventListener('keydown', function(e) {
      if (e.key !== 'Tab') return;
      const focusable = this.querySelectorAll('button, select, textarea, [tabindex]:not([tabindex="-1"])');
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    });

    function showReportError(message) {
      const errorEl = document.getElementById('report-error');
      errorEl.textContent = message;
    }

    function clearReportError() {
      document.getElementById('report-error').textContent = '';
    }

    async function submitReport() {
      const type = document.getElementById('report-type').value;
      const description = document.getElementById('report-description').value.trim();
      const submitBtn = document.getElementById('report-submit-btn');

      clearReportError();

      if (!description || description.length < 10) {
        showReportError('Please provide more details about the issue (at least 10 characters).');
        return;
      }

      if (description.length > 5000) {
        showReportError('Description too long. Please keep it under 5000 characters.');
        return;
      }

      // Disable button and show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      const payload = {
        type: type,
        description: description,
        context: {
          url: window.location.href,
          paperId: paperData.id || null,
          paperTitle: paperData.title || null,
          consoleLogs: (typeof capturedLogs !== 'undefined') ? capturedLogs.slice(-20) : [],
          userAgent: navigator.userAgent,
          viewport: { w: window.innerWidth, h: window.innerHeight },
          timestamp: new Date().toISOString(),
          referrer: document.referrer || ''
        }
      };

      // Create AbortController for timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);

      try {
        const res = await fetch('/api/report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        // Check response status before parsing
        if (!res.ok) {
          let errorMsg = 'Failed to submit report';
          try {
            const data = await res.json();
            errorMsg = data.error || errorMsg;
          } catch { /* ignore parse errors */ }
          showReportError(errorMsg);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Report';
          return;
        }

        const data = await res.json();

        if (data.success) {
          showToast('Report submitted. Thank you!');
          closeReportModal();
        } else {
          showReportError(data.error || 'Failed to submit report');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Report';
        }
      } catch (e) {
        clearTimeout(timeoutId);
        console.error('Report submission error:', e);
        const isTimeout = e.name === 'AbortError';
        showReportError(isTimeout ? 'Request timed out. Please try again.' : 'Network error. Please check your connection and try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Report';
      }
    }

    function copyLink() {
      copyToClipboard(window.location.href, 'Link copied!');
    }

    function bookmarkPaper() {
      try {
        const bookmarks = JSON.parse(localStorage.getItem('chinarxiv_bookmarks') || '[]');
        const bookmark = {
          id: {{ item.id|tojson }},
          title: {{ item.title_en|tojson }},
          url: window.location.href,
          date: new Date().toISOString()
        };
        if (!bookmarks.find(b => b.id === bookmark.id)) {
          bookmarks.push(bookmark);
          try {
            localStorage.setItem('chinarxiv_bookmarks', JSON.stringify(bookmarks));
            showToast('Bookmarked!');
          } catch (storageError) {
            if (storageError.name === 'QuotaExceededError') {
              showToast('Storage full - cannot bookmark');
            } else {
              throw storageError;
            }
          }
        } else {
          showToast('Already bookmarked');
        }
      } catch (e) {
        console.warn('Bookmarking unavailable', e);
        showToast('Bookmarking unavailable');
      }
    }
  </script>
{% endblock %}
