{% extends "base.html" %}
{% block header_breadcrumbs %}
  <div class="header-breadcrumbs">
    <a href="{{ root }}/">Home</a> <span class="sep">&gt;</span> Recent
  </div>
{% endblock %}
{% block content %}
  <div class="page-header">
    <h1>Recent Translations from ChinaXiv</h1>
    <p class="page-description">
      Automatically translated preprints from the Chinese arXiv (ChinaXiv).
    </p>
  </div>

  {# ========================================================================
     UNIFIED SEARCH CONTAINER - Server-side filtering
     ======================================================================== #}

  <div class="unified-search-container">
    <!-- Search Row - Form submission to server -->
    <div class="search-row">
      <form method="GET" action="/" class="search-form">
        <input type="text"
               class="search-input"
               name="q"
               value="{{ filters.search }}"
               placeholder="Search by title, authors, or abstract…"
               id="search-input">
        {# Preserve other filters #}
        {% if filters.category %}
          <input type="hidden" name="category" value="{{ filters.category }}">
        {% endif %}
        {% if filters.date_from %}
          <input type="hidden" name="from" value="{{ filters.date_from }}">
        {% endif %}
        {% if filters.date_to %}
          <input type="hidden" name="to" value="{{ filters.date_to }}">
        {% endif %}
        {% if filters.has_figures %}
          <input type="hidden" name="figures" value="1">
        {% endif %}
        <button type="submit" class="search-btn">Search</button>
      </form>
    </div>

    <!-- Tabs Row - Server-side navigation -->
    <div class="tabs-row">
      <nav class="subject-nav" role="tablist" aria-label="Category filters">
        <a href="/"
           class="category-tab {% if not filters.category %}active{% endif %}"
           role="tab"
           aria-selected="{% if not filters.category %}true{% else %}false{% endif %}"
           aria-controls="articles">
          All Recent
        </a>
        {% for category_id, category in categories.items()|sort(attribute='1.order') %}
        <a href="/?category={{ category_id }}"
           class="category-tab {% if filters.category == category_id %}active{% endif %}"
           role="tab"
           aria-selected="{% if filters.category == category_id %}true{% else %}false{% endif %}"
           aria-controls="articles">
          {{ category.label }}{% if category.count is defined %} ({{ category.count }}){% endif %}
        </a>
        {% endfor %}
      </nav>

      <button class="advanced-search-btn" id="advancedSearchBtn">
        <span>⚙</span>
        <span>Advanced Search & Filter</span>
        {% set active_filter_count = (1 if filters.date_from or filters.date_to else 0) + (1 if filters.has_figures else 0) %}
        <span class="badge" id="filterBadge" {% if active_filter_count == 0 %}style="display: none;"{% endif %}>{{ active_filter_count }}</span>
      </button>
    </div>

    <!-- Active Filter Indicators -->
    {% if filters.date_from or filters.date_to or filters.has_figures %}
    <div class="filter-indicators" id="filterIndicators">
      {% if filters.date_from or filters.date_to %}
      <span class="filter-pill">
        Date: {% if filters.date_from %}{{ filters.date_from }}{% else %}*{% endif %} to {% if filters.date_to %}{{ filters.date_to }}{% else %}*{% endif %}
        <a href="/?{% if filters.category %}category={{ filters.category }}&{% endif %}{% if filters.search %}q={{ filters.search }}{% endif %}"
           class="filter-pill-remove"
           aria-label="Remove date filter">×</a>
      </span>
      {% endif %}
      {% if filters.has_figures %}
      <span class="filter-pill">
        Papers with figures
        <a href="/?{% if filters.category %}category={{ filters.category }}&{% endif %}{% if filters.search %}q={{ filters.search }}&{% endif %}{% if filters.date_from %}from={{ filters.date_from }}&{% endif %}{% if filters.date_to %}to={{ filters.date_to }}{% endif %}"
           class="filter-pill-remove"
           aria-label="Remove figures filter">×</a>
      </span>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- Paper count -->
  <p class="paper-count" aria-live="polite" aria-atomic="true">
    Showing {{ items|length }} of {{ total }} paper{% if total != 1 %}s{% endif %}
    {% if filters.category %}
      in {{ categories[filters.category].label }}
    {% endif %}
  </p>

  {# ========================================================================
     ARTICLE LIST - Server-rendered
     ======================================================================== #}
  <div id="articles" class="article-list">
    {% for it in items %}
      <article class="paper-card">
        <h3 class="paper-title">
          <a href="{{ root }}/items/{{ it.id }}/" title="Abstract">{{ it.title_en or it.title }}</a>
        </h3>
        <div class="paper-meta-row">
          <span class="paper-authors">{{ ', '.join(it.creators_en if it.creators_en else ['Unknown']) }}</span>
        </div>
        <div class="paper-meta-row secondary">
          <span class="paper-date">{{ it.date[:10] if it.date else 'Unknown date' }}</span>
          <span class="paper-id">ChinaXiv:{{ it.id }}</span>
          <div class="paper-links">
            <a href="{{ root }}/items/{{ it.id }}/" class="btn-sm">Abstract</a>
            {% if it.pdf_url %}
              <a href="{{ it.pdf_url }}" class="btn-sm">PDF</a>
            {% endif %}
          </div>
        </div>
        <p class="paper-abstract">
          {{ it.abstract_en[:300] if it.abstract_en else '' }}{% if it.abstract_en and it.abstract_en|length > 300 %}…{% endif %}
        </p>
      </article>
    {% endfor %}
  </div>

  {% if not items %}
    <p style="color: #777; font-style: italic; margin-top: 40px;">No papers match your filters.</p>
  {% endif %}

  {# ========================================================================
     PAGINATION - Server-side
     ======================================================================== #}
  {% if total_pages > 1 %}
  <div class="pagination">
    {% if page > 1 %}
    <a href="/?page={{ page - 1 }}{% if filters.category %}&category={{ filters.category }}{% endif %}{% if filters.search %}&q={{ filters.search }}{% endif %}{% if filters.date_from %}&from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&to={{ filters.date_to }}{% endif %}{% if filters.has_figures %}&figures=1{% endif %}"
       class="pagination-btn">← Previous</a>
    {% else %}
    <span class="pagination-btn disabled">← Previous</span>
    {% endif %}

    <span class="pagination-info">Page {{ page }} of {{ total_pages }}</span>

    {% if page < total_pages %}
    <a href="/?page={{ page + 1 }}{% if filters.category %}&category={{ filters.category }}{% endif %}{% if filters.search %}&q={{ filters.search }}{% endif %}{% if filters.date_from %}&from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&to={{ filters.date_to }}{% endif %}{% if filters.has_figures %}&figures=1{% endif %}"
       class="pagination-btn">Next →</a>
    {% else %}
    <span class="pagination-btn disabled">Next →</span>
    {% endif %}
  </div>
  {% endif %}

  {# ========================================================================
     ADVANCED SEARCH MODAL - Server-side form submission
     ======================================================================== #}
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Advanced Search and Filter</h2>
        <button class="modal-close" id="modalClose">×</button>
      </div>

      <form method="GET" action="/" id="advancedSearchForm">
        <div class="modal-body">
          <!-- Search Term -->
          <div class="modal-section full-width">
            <div class="form-group">
              <label class="form-label" for="modalSearchInput">Search term</label>
              <input type="text"
                     class="form-input"
                     name="q"
                     id="modalSearchInput"
                     value="{{ filters.search }}"
                     placeholder="Enter keywords...">
            </div>
          </div>

          <!-- Note: Field-specific search and sort order not yet implemented in backend -->
          <!-- These will be added in future iterations -->

          <div class="modal-divider"></div>

          <!-- Date Range -->
          <div class="modal-section">
            <div class="modal-section-title">Date range</div>
            <div class="date-range">
              <input type="date"
                     class="form-input"
                     name="from"
                     id="startDate"
                     value="{{ filters.date_from }}"
                     placeholder="Start date">
              <span class="date-range-separator">to</span>
              <input type="date"
                     class="form-input"
                     name="to"
                     id="endDate"
                     value="{{ filters.date_to }}"
                     placeholder="End date">
            </div>
          </div>

          <div class="modal-divider"></div>

          <!-- Filters -->
          <div class="modal-section">
            <div class="modal-section-title">Filters</div>
            <div class="checkbox-group">
              <div class="checkbox-option">
                <input type="checkbox"
                       id="onlyFigures"
                       name="figures"
                       value="1"
                       {% if filters.has_figures %}checked{% endif %}>
                <label for="onlyFigures">Only papers with figures</label>
              </div>
            </div>
          </div>

          <!-- Note: Category selection modal will be re-implemented in future iteration -->
          <!-- For now, use category tabs above -->
        </div>

        <div class="modal-footer">
          <a href="/" class="btn-secondary">Clear All</a>
          <button type="submit" class="btn-primary">Apply</button>
        </div>
      </form>
    </div>
  </div>

  {# Minimal JavaScript for modal open/close only #}
  <script>
    // Modal controls (no filtering logic - just UI)
    const modalOverlay = document.getElementById('modalOverlay');
    const advancedSearchBtn = document.getElementById('advancedSearchBtn');
    const modalClose = document.getElementById('modalClose');

    if (advancedSearchBtn) {
      advancedSearchBtn.addEventListener('click', () => {
        modalOverlay.style.display = 'flex';
      });
    }

    if (modalClose) {
      modalClose.addEventListener('click', () => {
        modalOverlay.style.display = 'none';
      });
    }

    if (modalOverlay) {
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
          modalOverlay.style.display = 'none';
        }
      });
    }
  </script>
{% endblock %}
