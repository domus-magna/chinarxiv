{% extends "base.html" %}
{% block header_breadcrumbs %}
  <div class="header-breadcrumbs">
    <a href="{{ root }}/">Home</a> <span class="sep">&gt;</span> Recent
  </div>
{% endblock %}
{% block content %}
  <div class="page-header">
    <h1>Recent Translations from ChinaXiv</h1>
    <p class="page-description">
      Automatically translated preprints from the Chinese arXiv (ChinaXiv).
    </p>
  </div>

  {# ========================================================================
     UNIFIED SEARCH CONTAINER - Server-side filtering
     ======================================================================== #}

  <div class="unified-search-container">
    <!-- Search Row - Form submission to server -->
    <div class="search-row">
      <form method="GET" action="/" class="search-form">
        <input type="text"
               class="search-input"
               name="q"
               value="{{ filters.search }}"
               placeholder="Search by title, authors, or abstract…"
               id="search-input">
        {# Preserve other filters #}
        {% if filters.category %}
          <input type="hidden" name="category" value="{{ filters.category }}">
        {% endif %}
        {% if filters.date_from %}
          <input type="hidden" name="from" value="{{ filters.date_from }}">
        {% endif %}
        {% if filters.date_to %}
          <input type="hidden" name="to" value="{{ filters.date_to }}">
        {% endif %}
        {% if filters.has_figures %}
          <input type="hidden" name="figures" value="1">
        {% endif %}
        {% if filters.subjects %}
          {% for subject in filters.subjects %}
            <input type="hidden" name="subjects" value="{{ subject }}">
          {% endfor %}
        {% endif %}
        <button type="submit" class="search-btn">Search</button>
      </form>
    </div>

    <!-- Tabs Row - Server-side navigation -->
    <div class="tabs-row">
      <nav class="subject-nav" role="tablist" aria-label="Category filters">
        <a href="/?{% if filters.search %}q={{ filters.search }}&{% endif %}{% if filters.date_from %}from={{ filters.date_from }}&{% endif %}{% if filters.date_to %}to={{ filters.date_to }}&{% endif %}{% if filters.has_figures %}figures=1{% endif %}"
           class="category-tab {% if not filters.category %}active{% endif %}"
           role="tab"
           aria-selected="{% if not filters.category %}true{% else %}false{% endif %}"
           aria-controls="articles"
           data-umami-event="filter-category"
           data-umami-event-category="All Recent">
          All Recent
        </a>
        {% for category_id, category in categories.items()|sort(attribute='1.order') %}
        <a href="/?category={{ category_id }}{% if filters.search %}&q={{ filters.search }}{% endif %}{% if filters.date_from %}&from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&to={{ filters.date_to }}{% endif %}{% if filters.has_figures %}&figures=1{% endif %}"
           class="category-tab {% if filters.category == category_id %}active{% endif %}"
           role="tab"
           aria-selected="{% if filters.category == category_id %}true{% else %}false{% endif %}"
           aria-controls="articles"
           data-umami-event="filter-category"
           data-umami-event-category="{{ category.label }}">
          {{ category.label }}{% if category.count is defined %} ({{ category.count }}){% endif %}
        </a>
        {% endfor %}
      </nav>

      <button class="advanced-search-btn" id="advancedSearchBtn">
        <span>⚙</span>
        <span>Advanced Search & Filter</span>
        {% set active_filter_count = (1 if filters.date_from or filters.date_to else 0) + (1 if filters.has_figures else 0) + (filters.subjects|length if filters.subjects else 0) %}
        <span class="badge" id="filterBadge" {% if active_filter_count == 0 %}style="display: none;"{% endif %}>{{ active_filter_count }}</span>
      </button>
    </div>

    <!-- Active Filter Indicators -->
    {% if filters.date_from or filters.date_to or filters.has_figures or filters.subjects %}
    <div class="filter-indicators" id="filterIndicators">
      {% if filters.date_from or filters.date_to %}
      <span class="filter-pill">
        Date: {% if filters.date_from %}{{ filters.date_from }}{% else %}*{% endif %} to {% if filters.date_to %}{{ filters.date_to }}{% else %}*{% endif %}
        <a href="/?{% if filters.category %}category={{ filters.category }}&{% endif %}{% if filters.search %}q={{ filters.search }}&{% endif %}{% for subject in filters.subjects %}subjects={{ subject|urlencode }}&{% endfor %}{% if filters.has_figures %}figures=1{% endif %}"
           class="filter-pill-remove"
           aria-label="Remove date filter">×</a>
      </span>
      {% endif %}
      {% if filters.has_figures %}
      <span class="filter-pill">
        Papers with figures
        <a href="/?{% if filters.category %}category={{ filters.category }}&{% endif %}{% if filters.search %}q={{ filters.search }}&{% endif %}{% if filters.date_from %}from={{ filters.date_from }}&{% endif %}{% if filters.date_to %}to={{ filters.date_to }}&{% endif %}{% for subject in filters.subjects %}subjects={{ subject|urlencode }}&{% endfor %}"
           class="filter-pill-remove"
           aria-label="Remove figures filter">×</a>
      </span>
      {% endif %}
      {% if filters.subjects %}
        {% for subject in filters.subjects %}
        <span class="filter-pill">
          {{ subject }}
          <a href="/?{% if filters.category %}category={{ filters.category }}&{% endif %}{% if filters.search %}q={{ filters.search }}&{% endif %}{% if filters.date_from %}from={{ filters.date_from }}&{% endif %}{% if filters.date_to %}to={{ filters.date_to }}&{% endif %}{% if filters.has_figures %}figures=1&{% endif %}{% for s in filters.subjects if s != subject %}subjects={{ s|urlencode }}&{% endfor %}"
             class="filter-pill-remove"
             aria-label="Remove {{ subject }} filter">×</a>
        </span>
        {% endfor %}
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- Paper count -->
  <p class="paper-count" aria-live="polite" aria-atomic="true">
    Showing {{ items|length }} of {{ total }} paper{% if total != 1 %}s{% endif %}
    {% if filters.category and filters.category in categories %}
      in {{ categories[filters.category].label }}
    {% endif %}
  </p>

  {# ========================================================================
     ARTICLE LIST - Server-rendered
     ======================================================================== #}
  <div id="articles" class="article-list">
    {% for it in items %}
      <article class="paper-card">
        <h3 class="paper-title">
          <a href="{{ root }}/items/{{ it.id }}" title="Abstract">{{ it.title_en or it.title }}</a>
        </h3>
        <div class="paper-meta-row">
          <span class="paper-authors">{{ ', '.join(it.creators_en or it.creators or ['Unknown']) }}</span>
        </div>
        <div class="paper-meta-row secondary">
          <span class="paper-date">{{ it.date[:10] if it.date else 'Unknown date' }}</span>
          <span class="paper-id">ChinaXiv:{{ it.id }}</span>
          <div class="paper-links">
            <a href="{{ root }}/items/{{ it.id }}" class="btn-sm">Abstract</a>
            {% if it._has_english_pdf %}
              <a href="{{ it._english_pdf_url or (root ~ '/items/' ~ it.id ~ '.pdf') }}" class="btn-sm" target="_blank" rel="noopener">PDF</a>
            {% endif %}
          </div>
        </div>
        <p class="paper-abstract">
          {% set _abstract_preview = (it.abstract_md or it.abstract_en or '') | markdown | striptags %}
          {{ _abstract_preview[:300] }}{% if _abstract_preview and _abstract_preview|length > 300 %}…{% endif %}
        </p>
      </article>
    {% endfor %}
  </div>

  {% if not items %}
    <p style="color: #777; font-style: italic; margin-top: 40px;">No papers match your filters.</p>
  {% endif %}

  {# ========================================================================
     PAGINATION - Server-side
     ======================================================================== #}
  {% if total_pages > 1 %}
  <div class="pagination">
    {% if page > 1 %}
    <a href="/?page={{ page - 1 }}{% if filters.category %}&category={{ filters.category }}{% endif %}{% if filters.search %}&q={{ filters.search }}{% endif %}{% if filters.date_from %}&from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&to={{ filters.date_to }}{% endif %}{% if filters.has_figures %}&figures=1{% endif %}"
       class="pagination-btn">← Previous</a>
    {% else %}
    <span class="pagination-btn disabled">← Previous</span>
    {% endif %}

    <span class="pagination-info">Page {{ page }} of {{ total_pages }}</span>

    {% if page < total_pages %}
    <a href="/?page={{ page + 1 }}{% if filters.category %}&category={{ filters.category }}{% endif %}{% if filters.search %}&q={{ filters.search }}{% endif %}{% if filters.date_from %}&from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&to={{ filters.date_to }}{% endif %}{% if filters.has_figures %}&figures=1{% endif %}"
       class="pagination-btn">Next →</a>
    {% else %}
    <span class="pagination-btn disabled">Next →</span>
    {% endif %}
  </div>
  {% endif %}

  {# ========================================================================
     ADVANCED SEARCH MODAL - Server-side form submission
     ======================================================================== #}
  <div class="modal-overlay"
       id="modalOverlay"
       role="dialog"
       aria-modal="true"
       aria-labelledby="modal-title">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Advanced Search and Filter</h2>
        <button class="modal-close" id="modalClose">×</button>
      </div>

      <form method="GET" action="/" id="advancedSearchForm">
        <div class="modal-body">
          <!-- Search Term -->
          <div class="modal-section full-width">
            <div class="form-group">
              <label class="form-label" for="modalSearchInput">Search term</label>
              <input type="text"
                     class="form-input"
                     name="q"
                     id="modalSearchInput"
                     value="{{ filters.search }}"
                     placeholder="Enter keywords...">
            </div>
          </div>

          <!-- Note: Field-specific search and sort order not yet implemented in backend -->
          <!-- These will be added in future iterations -->

          <div class="modal-divider"></div>

          <!-- Date Range -->
          <div class="modal-section">
            <div class="modal-section-title">Date range</div>
            <div class="date-range">
              <input type="date"
                     class="form-input"
                     name="from"
                     id="startDate"
                     value="{{ filters.date_from }}"
                     placeholder="Start date">
              <span class="date-range-separator">to</span>
              <input type="date"
                     class="form-input"
                     name="to"
                     id="endDate"
                     value="{{ filters.date_to }}"
                     placeholder="End date">
            </div>
          </div>

          <div class="modal-divider"></div>

          <!-- Filters -->
          <div class="modal-section">
            <div class="modal-section-title">Filters</div>
            <div class="checkbox-group">
              <div class="checkbox-option">
                <input type="checkbox"
                       id="onlyFigures"
                       name="figures"
                       value="1"
                       {% if filters.has_figures %}checked{% endif %}>
                <label for="onlyFigures">Only papers with figures</label>
              </div>
            </div>
          </div>

          <div class="modal-divider"></div>

          <!-- Subject Filters -->
          <div class="modal-section full-width">
            <div class="modal-section-header">
              <div class="modal-section-title">Filter by Subject</div>
              <button type="button" class="collapse-all-btn" id="collapseAllBtn">Collapse All</button>
            </div>

            <div class="filter-categories-list">
              {% set all_categories = available_filters.items()|sort(attribute='1.order') %}

              {% for category_id, category_data in all_categories %}
              <div class="category-section">
                <button type="button"
                        class="category-header"
                        data-category="{{ category_id }}"
                        aria-expanded="false"
                        aria-controls="category-{{ category_id }}-subjects">
                  <span class="caret" aria-hidden="true">▼</span>
                  <span class="category-label">
                    {{ category_data.label }}
                    ({{ category_data.subjects|map(attribute='count')|sum }})
                  </span>
                </button>
                <div id="category-{{ category_id }}-subjects"
                     class="category-subjects-grid"
                     data-category="{{ category_id }}">
                  {% for subject in category_data.subjects %}
                  <label class="subject-checkbox">
                    <input type="checkbox"
                           name="subjects"
                           value="{{ subject.name }}"
                           id="subject-{{ subject.name|replace(' ', '_')|replace('&', 'and') }}"
                           {% if subject.name in filters.subjects %}checked{% endif %}>
                    <span>{{ subject.name }} ({{ subject.count }})</span>
                  </label>
                  {% endfor %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <a href="/" class="btn-secondary">Clear All</a>
          <button type="submit" class="btn-primary">Apply</button>
        </div>
      </form>
    </div>
  </div>

  {# Minimal JavaScript for modal open/close only #}
  <script>
    // Modal controls (no filtering logic - just UI)
    const modalOverlay = document.getElementById('modalOverlay');
    const advancedSearchBtn = document.getElementById('advancedSearchBtn');
    const modalClose = document.getElementById('modalClose');

    if (advancedSearchBtn) {
      advancedSearchBtn.addEventListener('click', () => {
        modalOverlay.style.display = 'flex';
        // Trigger reflow to enable animation
        requestAnimationFrame(() => {
          modalOverlay.classList.add('modal-open');
        });
      });
    }

    if (modalClose) {
      modalClose.addEventListener('click', () => {
        modalOverlay.classList.remove('modal-open');
        // Wait for animation to complete before hiding
        setTimeout(() => {
          if (!modalOverlay.classList.contains('modal-open')) {
            modalOverlay.style.display = 'none';
          }
        }, 200);  // Match CSS transition duration (0.2s)
      });
    }

    if (modalOverlay) {
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
          modalOverlay.classList.remove('modal-open');
          // Wait for animation to complete before hiding
          setTimeout(() => {
            if (!modalOverlay.classList.contains('modal-open')) {
              modalOverlay.style.display = 'none';
            }
          }, 200);  // Match CSS transition duration (0.2s)
        }
      });
    }

    // Category collapse/expand functionality
    const categoryHeaders = document.querySelectorAll('.category-header');
    const collapseAllBtn = document.getElementById('collapseAllBtn');

    // Toggle individual category section
    categoryHeaders.forEach(header => {
      header.addEventListener('click', () => {
        const categoryId = header.getAttribute('data-category');
        const subjects = document.querySelector(`.category-subjects-grid[data-category="${categoryId}"]`);

        // Toggle collapsed class on both header and subjects
        const isExpanded = !header.classList.contains('collapsed');
        header.classList.toggle('collapsed');
        subjects.classList.toggle('collapsed');

        // Update ARIA attribute for accessibility
        header.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');

        // Update Collapse All button text based on current state
        updateCollapseAllButton();
      });
    });

    // Collapse All / Expand All button
    if (collapseAllBtn) {
      collapseAllBtn.addEventListener('click', () => {
        const allCollapsed = Array.from(categoryHeaders).every(h => h.classList.contains('collapsed'));

        categoryHeaders.forEach(header => {
          const categoryId = header.getAttribute('data-category');
          const subjects = document.querySelector(`.category-subjects-grid[data-category="${categoryId}"]`);

          if (allCollapsed) {
            // Expand all
            header.classList.remove('collapsed');
            subjects.classList.remove('collapsed');
            header.setAttribute('aria-expanded', 'true');
          } else {
            // Collapse all
            header.classList.add('collapsed');
            subjects.classList.add('collapsed');
            header.setAttribute('aria-expanded', 'false');
          }
        });

        updateCollapseAllButton();
      });
    }

    // Update Collapse All button text
    function updateCollapseAllButton() {
      if (!collapseAllBtn) return;

      const allCollapsed = Array.from(categoryHeaders).every(h => h.classList.contains('collapsed'));
      collapseAllBtn.textContent = allCollapsed ? 'Expand All' : 'Collapse All';
    }

    // Form submission loading state and tracking
    const advancedSearchForm = document.getElementById('advancedSearchForm');
    if (advancedSearchForm) {
      advancedSearchForm.addEventListener('submit', (e) => {
        const submitBtn = advancedSearchForm.querySelector('.btn-primary');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span class="loading-spinner">⟳</span> Applying...';
        }

        // Track advanced search usage
        const formData = new FormData(advancedSearchForm);
        const subjects = formData.getAll('subjects');
        trackEvent('filter-advanced', {
          has_search: !!formData.get('q'),
          has_date: !!(formData.get('from') || formData.get('to')),
          has_figures: formData.get('figures') === '1',
          subject_count: subjects.length
        });
      });
    }
  </script>
{% endblock %}
