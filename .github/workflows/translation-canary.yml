name: translation-canary
# ============================================================================
# PURPOSE: Daily health check that validates the full translation pipeline.
#
# WHAT IT TESTS:
# - Fresh metadata fetch from ChinaXiv (no stale harvested records)
# - PDF download via BrightData browser proxy
# - Text translation via OpenRouter
# - QA validation (Chinese leakage check)
#
# WHY COMPLETE_PAPER_PROCESSOR:
# Uses the complete_paper_processor module instead of src.translate to test
# the true E2E path. This catches issues like:
# - ChinaXiv HTML structure changes
# - IP-bound UUID session problems
# - Stale harvest data that would mask real issues
#
# SECRETS REQUIRED:
# - OPENROUTER_API_KEY: Text translation API
# - BRIGHTDATA_API_KEY: Proxy service authentication
# - BRIGHTDATA_BROWSER_WSS: Browser proxy WebSocket endpoint
# ============================================================================

on:
  schedule:
    - cron: "0 6 * * *"  # daily 06:00 UTC
  workflow_dispatch:

jobs:
  canary:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Preflight env check
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          BRIGHTDATA_API_KEY: ${{ secrets.BRIGHTDATA_API_KEY }}
          BRIGHTDATA_BROWSER_WSS: ${{ secrets.BRIGHTDATA_BROWSER_WSS }}
        run: |
          # Validate critical secrets are present
          if [ -z "$OPENROUTER_API_KEY" ]; then
            echo "::error::OPENROUTER_API_KEY is missing"
            exit 1
          fi
          if [ -z "$BRIGHTDATA_API_KEY" ] && [ -z "$BRIGHTDATA_BROWSER_WSS" ]; then
            echo "::warning::No BrightData credentials - PDF download may fail"
          fi
          python -m src.tools.env_diagnose --check || true

      - name: Run canary translations
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          BRIGHTDATA_API_KEY: ${{ secrets.BRIGHTDATA_API_KEY }}
          BRIGHTDATA_BROWSER_WSS: ${{ secrets.BRIGHTDATA_BROWSER_WSS }}
          BRIGHTDATA_UNLOCKER_PASSWORD: ${{ secrets.BRIGHTDATA_UNLOCKER_PASSWORD }}
          BRIGHTDATA_UNLOCKER_ZONE: ${{ secrets.BRIGHTDATA_UNLOCKER_ZONE }}
          NO_PROXY: openrouter.ai,api.openrouter.ai
        run: |
          set -euo pipefail

          # Test papers - chosen for stability and reasonable size
          ids=(202510.00016 202510.00020 202510.00022)

          for id in "${ids[@]}"; do
            echo "::group::Canary: chinaxiv-$id"

            # Use complete_paper_processor for true E2E testing:
            # - Fresh metadata fetch (not from harvested records)
            # - Fresh PDF download (with session-based proxy)
            # - Translation + QA
            # - No B2 upload (--no-upload) - this is just a health check
            # - No figures (--no-figures) - saves time and API costs
            # - Force re-process (--force) - ignore any existing translations
            PYTHONUNBUFFERED=1 python -m src.complete_paper_processor \
              --paper-id "$id" \
              --no-upload \
              --no-figures \
              --force \
              --workdir .

            echo "::endgroup::"
          done

      - name: Verify QA pass
        run: |
          set -euo pipefail

          ids=(202510.00016 202510.00020 202510.00022)
          failed=0

          for id in "${ids[@]}"; do
            path="data/translated/chinaxiv-${id}.json"

            if [ ! -f "$path" ]; then
              echo "::error::Translation file not found: $path"
              failed=1
              continue
            fi

            status=$(jq -r '._qa_status' "$path")
            ratio=$(jq -r '._qa_chinese_ratio // 0' "$path")

            # QA must pass and Chinese ratio must be 0 (no leakage)
            ratio_positive=$(jq '(._qa_chinese_ratio // 0) > 0' "$path")

            if [ "$status" != "pass" ] || [ "$ratio_positive" = "true" ]; then
              echo "::error::QA failed for chinaxiv-$id (status=$status, ratio=$ratio)"
              failed=1
            else
              echo "QA passed for chinaxiv-$id (status=$status, ratio=$ratio)"
            fi
          done

          if [ "$failed" -eq 1 ]; then
            exit 1
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canary-translations
          path: |
            data/translated/chinaxiv-202510.*.json
            data/pdfs/chinaxiv-202510.*.pdf
          if-no-files-found: ignore
          retention-days: 7
