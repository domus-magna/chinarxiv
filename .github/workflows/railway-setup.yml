name: Railway Database Setup

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - create-schema
          - verify-connection
        default: 'create-schema'

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install psycopg2-binary

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Link to Railway project
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link --environment production

      - name: Verify database connection
        if: inputs.action == 'verify-connection'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway run python -c "
          import psycopg2
          import os
          conn = psycopg2.connect(os.environ['DATABASE_URL'])
          cur = conn.cursor()
          cur.execute('SELECT version()')
          print('PostgreSQL version:', cur.fetchone()[0])
          conn.close()
          print('Connection successful!')
          "

      - name: Create database schema
        if: inputs.action == 'create-schema'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway run python scripts/create_schema.py
