name: Reconcile DB State from B2
# ============================================================================
# PURPOSE: Weekly sync of PostgreSQL state from B2 storage.
#
# The orchestrator trusts PostgreSQL as the source of truth, but state can
# drift if:
# - Manual B2 uploads/deletions
# - Workflow failures after B2 upload but before DB update
# - Database restore from backup
#
# This workflow scans B2 storage and updates PostgreSQL to match reality.
# Run weekly or manually when drift is suspected.
#
# WHAT IT DOES:
# 1. Scans B2 for existing PDFs, translations, figures
# 2. Updates processing_status columns in PostgreSQL
# 3. Logs any discrepancies found
#
# SAFE TO RUN ANYTIME - idempotent operation
# ============================================================================

on:
  workflow_dispatch:
    inputs:
      dry_run:
        type: boolean
        default: false
        description: "Show what would change without modifying DB"

      limit:
        type: string
        description: "Limit number of papers to process (for testing)"
        required: false

  schedule:
    # Every Sunday at 4 AM UTC
    - cron: '0 4 * * 0'

# Minimal permissions - only read code, no writes needed
permissions:
  contents: read

run-name: reconcile-state${{ inputs.dry_run && ' [dry-run]' || '' }}

jobs:
  reconcile:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary boto3

      - name: Validate credentials
        run: |
          missing=""
          [ -z "${{ secrets.DATABASE_URL }}" ] && missing="$missing DATABASE_URL"
          [ -z "${{ secrets.BACKBLAZE_KEY_ID }}" ] && missing="$missing BACKBLAZE_KEY_ID"
          [ -z "${{ secrets.BACKBLAZE_APPLICATION_KEY }}" ] && missing="$missing BACKBLAZE_APPLICATION_KEY"
          [ -z "${{ secrets.BACKBLAZE_BUCKET }}" ] && missing="$missing BACKBLAZE_BUCKET"

          if [ -n "$missing" ]; then
            echo "::error::Missing required secrets:$missing"
            exit 1
          fi
          echo "All required credentials present"

      - name: Reconcile state from B2
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          AWS_ACCESS_KEY_ID: ${{ secrets.BACKBLAZE_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BACKBLAZE_APPLICATION_KEY }}
          AWS_DEFAULT_REGION: us-west-004
          BACKBLAZE_KEY_ID: ${{ secrets.BACKBLAZE_KEY_ID }}
          BACKBLAZE_APPLICATION_KEY: ${{ secrets.BACKBLAZE_APPLICATION_KEY }}
          BACKBLAZE_S3_ENDPOINT: ${{ secrets.BACKBLAZE_S3_ENDPOINT }}
          BACKBLAZE_BUCKET: ${{ secrets.BACKBLAZE_BUCKET }}
          BACKBLAZE_PREFIX: ${{ secrets.BACKBLAZE_PREFIX }}
          # Pass inputs via env vars to prevent command substitution attacks
          INPUT_DRY_RUN: ${{ inputs.dry_run }}
          INPUT_LIMIT: ${{ inputs.limit }}
        run: |
          set -e

          # Build command using array to avoid eval/string interpolation attacks
          CMD=(python scripts/backfill_state_from_b2.py)

          if [ "$INPUT_DRY_RUN" = "true" ]; then
            CMD+=(--dry-run)
          fi

          # Validate limit is numeric if provided
          if [ -n "$INPUT_LIMIT" ]; then
            if ! [[ "$INPUT_LIMIT" =~ ^[0-9]+$ ]]; then
              echo "::error::limit must be a number (got: $INPUT_LIMIT)"
              exit 1
            fi
            CMD+=(--limit "$INPUT_LIMIT")
          fi

          echo "Running: ${CMD[*]}"
          "${CMD[@]}"
