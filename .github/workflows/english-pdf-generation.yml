name: Generate English PDFs

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Generation mode'
        required: true
        type: choice
        options:
          - backfill
          - incremental
          - figures-update
        default: 'incremental'
      days:
        description: 'For incremental: days to look back'
        required: false
        default: '7'
  schedule:
    # Run nightly at 6 AM UTC (after daily translations complete)
    - cron: '0 6 * * *'

jobs:
  generate-pdfs:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours max for backfill

    steps:
      - name: Set Backblaze region
        run: echo "AWS_DEFAULT_REGION=us-west-004" >> $GITHUB_ENV

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3 python-dotenv

      - name: Install pandoc and XeLaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends pandoc texlive-xetex texlive-fonts-recommended fonts-noto-cjk lmodern
          which pandoc || { echo "‚ùå pandoc installation failed"; exit 1; }
          which xelatex || { echo "‚ùå xelatex installation failed"; exit 1; }
          pandoc --version | head -1
          echo "‚úÖ PDF tools installed"

      - name: Hydrate translations from B2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.BACKBLAZE_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BACKBLAZE_APPLICATION_KEY }}
          BACKBLAZE_S3_ENDPOINT: ${{ secrets.BACKBLAZE_S3_ENDPOINT }}
          BACKBLAZE_BUCKET: ${{ secrets.BACKBLAZE_BUCKET }}
        run: |
          set -e
          if [ -z "${AWS_ACCESS_KEY_ID}" ] || [ -z "${AWS_SECRET_ACCESS_KEY}" ]; then
            echo "‚ùå Missing B2 credentials"
            exit 1
          fi

          pip install awscli >/dev/null 2>&1
          DEST="s3://${BACKBLAZE_BUCKET}/"

          # Download translations
          mkdir -p data/translated
          echo "‚¨áÔ∏è  Downloading translations from B2..."
          aws s3 sync "${DEST}validated/translations" data/translated \
            --exclude "*" --include "*.json" \
            --endpoint-url "${BACKBLAZE_S3_ENDPOINT}" --only-show-errors

          COUNT=$(ls -1 data/translated/*.json 2>/dev/null | wc -l | tr -d ' ')
          echo "Found ${COUNT} translation files"

          # Download figure manifest (for translated figures in PDFs)
          echo "‚¨áÔ∏è  Downloading figure manifest..."
          aws s3 cp "${DEST}figures/manifest.json" data/figure_manifest.json \
            --endpoint-url "${BACKBLAZE_S3_ENDPOINT}" || echo "‚ö†Ô∏è No figure manifest found"

      - name: Generate PDFs
        env:
          BACKBLAZE_S3_ENDPOINT: ${{ secrets.BACKBLAZE_S3_ENDPOINT }}
          BACKBLAZE_KEY_ID: ${{ secrets.BACKBLAZE_KEY_ID }}
          BACKBLAZE_APPLICATION_KEY: ${{ secrets.BACKBLAZE_APPLICATION_KEY }}
          BACKBLAZE_BUCKET: ${{ secrets.BACKBLAZE_BUCKET }}
        run: |
          MODE="${{ github.event.inputs.mode || 'incremental' }}"
          DAYS="${{ github.event.inputs.days || '7' }}"

          echo "üî® Generating PDFs (mode=${MODE}, days=${DAYS})..."
          python scripts/generate_english_pdfs.py --mode "${MODE}" --days "${DAYS}"

          # Count generated PDFs
          PDF_COUNT=$(ls -1 data/english_pdfs/*.pdf 2>/dev/null | wc -l | tr -d ' ')
          echo "üìÑ Generated ${PDF_COUNT} PDFs"

      - name: Upload PDFs to B2
        env:
          BACKBLAZE_S3_ENDPOINT: ${{ secrets.BACKBLAZE_S3_ENDPOINT }}
          BACKBLAZE_KEY_ID: ${{ secrets.BACKBLAZE_KEY_ID }}
          BACKBLAZE_APPLICATION_KEY: ${{ secrets.BACKBLAZE_APPLICATION_KEY }}
          BACKBLAZE_BUCKET: ${{ secrets.BACKBLAZE_BUCKET }}
        run: |
          set -e
          if [ ! -d data/english_pdfs ] || [ -z "$(ls -A data/english_pdfs/*.pdf 2>/dev/null)" ]; then
            echo "No PDFs to upload"
            exit 0
          fi

          echo "üì§ Uploading PDFs to B2..."
          python scripts/upload_english_pdfs.py

      - name: Sync to Railway database
        env:
          DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
          BACKBLAZE_S3_ENDPOINT: ${{ secrets.BACKBLAZE_S3_ENDPOINT }}
          BACKBLAZE_KEY_ID: ${{ secrets.BACKBLAZE_KEY_ID }}
          BACKBLAZE_APPLICATION_KEY: ${{ secrets.BACKBLAZE_APPLICATION_KEY }}
          BACKBLAZE_BUCKET: ${{ secrets.BACKBLAZE_BUCKET }}
        run: |
          if [ -z "${DATABASE_URL}" ]; then
            echo "‚ö†Ô∏è RAILWAY_DATABASE_URL not set - skipping DB sync"
            echo "Run manually: python scripts/sync_english_pdfs_from_b2.py"
            exit 0
          fi

          pip install psycopg2-binary >/dev/null 2>&1
          echo "üìä Syncing PDF URLs to database..."
          python scripts/sync_english_pdfs_from_b2.py

      - name: Summary
        run: |
          echo "=" | tr -d '\n' | head -c 60
          echo ""
          echo "PDF Generation Complete"
          echo "=" | tr -d '\n' | head -c 60
          echo ""

          PDF_COUNT=$(ls -1 data/english_pdfs/*.pdf 2>/dev/null | wc -l | tr -d ' ')
          echo "üìÑ PDFs generated this run: ${PDF_COUNT}"

          if [ -f data/english_pdfs/manifest.json ]; then
            TOTAL=$(python -c "import json; print(len(json.load(open('data/english_pdfs/manifest.json', 'r')).get('papers', {})))" 2>/dev/null || echo "unknown")
            echo "üìÅ Total PDFs in B2: ${TOTAL}"
          fi

      - name: Notify on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "${DISCORD_WEBHOOK_URL}" ]; then
            exit 0
          fi
          curl -s -X POST "${DISCORD_WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            -d '{"embeds":[{"title":"‚ùå English PDF Generation Failed","description":"Check workflow logs for details","color":15158332}]}'
