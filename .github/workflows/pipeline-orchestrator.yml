name: Pipeline Orchestrator

on:
  workflow_dispatch:
    inputs:
      stages:
        description: 'Pipeline stages to run (comma-separated: preflight,harvest,ocr,translate,qa,figures,render)'
        required: false
        default: 'preflight,harvest,ocr,translate,qa,figures,render'
      month:
        description: 'Month for figure processing (YYYYMM) - required if figures stage is included'
        required: false
        default: ''
      batch_size:
        description: 'Papers per batch'
        required: false
        default: '100'
      workers:
        description: 'Parallel workers per stage'
        required: false
        default: '20'
      matrix_size:
        description: 'Matrix parallelism (number of parallel jobs)'
        required: false
        default: '3'

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    outputs:
      stages: ${{ steps.parse-stages.outputs.stages }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse stages
        id: parse-stages
        run: |
          STAGES="${{ github.event.inputs.stages || 'preflight,harvest,ocr,translate,qa,figures,render' }}"
          echo "stages=$STAGES" >> $GITHUB_OUTPUT
          echo "Running stages: $STAGES"

          REF="${GITHUB_REF}"
          if [[ "$REF" == refs/heads/* ]]; then
            HEAD_BRANCH="${REF#refs/heads/}"
          else
            HEAD_BRANCH=""
          fi
          echo "head-branch=$HEAD_BRANCH" >> $GITHUB_OUTPUT

          BATCH_SIZE="${{ github.event.inputs.batch_size || '100' }}"
          WORKERS="${{ github.event.inputs.workers || '20' }}"
          MATRIX_SIZE="${{ github.event.inputs.matrix_size || '3' }}"
          MONTH="${{ github.event.inputs.month || '' }}"
          echo "batch-size=$BATCH_SIZE" >> $GITHUB_OUTPUT
          echo "workers=$WORKERS" >> $GITHUB_OUTPUT
          echo "matrix-size=$MATRIX_SIZE" >> $GITHUB_OUTPUT
          echo "month=$MONTH" >> $GITHUB_OUTPUT

      - name: Export orchestrator inputs
        run: |
          echo "HEAD_BRANCH=${{ steps.parse-stages.outputs['head-branch'] }}" >> $GITHUB_ENV
          echo "BATCH_SIZE=${{ steps.parse-stages.outputs['batch-size'] }}" >> $GITHUB_ENV
          echo "WORKERS=${{ steps.parse-stages.outputs['workers'] }}" >> $GITHUB_ENV
          echo "MATRIX_SIZE=${{ steps.parse-stages.outputs['matrix-size'] }}" >> $GITHUB_ENV
          echo "MONTH=${{ steps.parse-stages.outputs['month'] }}" >> $GITHUB_ENV

      - name: Initialize stage tracking
        run: |
          echo "COMPLETED_STAGES=" >> $GITHUB_ENV
          echo "LAST_STAGE=not-started" >> $GITHUB_ENV

      - name: Mark stage preflight
        if: success() && contains(steps.parse-stages.outputs.stages, 'preflight')
        run: echo "LAST_STAGE=preflight" >> $GITHUB_ENV

      - name: Run preflight gate
        if: success() && contains(steps.parse-stages.outputs.stages, 'preflight')
        uses: ./.github/actions/run-gate
        with:
          workflow: preflight.yml
          ref: ${{ github.ref }}
          head-branch: ${{ steps.parse-stages.outputs['head-branch'] }}

      - name: Record preflight completion
        if: success() && contains(steps.parse-stages.outputs.stages, 'preflight')
        run: echo "COMPLETED_STAGES=${COMPLETED_STAGES}preflight " >> $GITHUB_ENV

      - name: Mark stage harvest
        if: success() && contains(steps.parse-stages.outputs.stages, 'harvest')
        run: echo "LAST_STAGE=harvest" >> $GITHUB_ENV

      - name: Run harvest gate
        if: success() && contains(steps.parse-stages.outputs.stages, 'harvest')
        uses: ./.github/actions/run-gate
        with:
          workflow: harvest-gate.yml
          ref: ${{ github.ref }}
          head-branch: ${{ steps.parse-stages.outputs['head-branch'] }}

      - name: Record harvest completion
        if: success() && contains(steps.parse-stages.outputs.stages, 'harvest')
        run: echo "COMPLETED_STAGES=${COMPLETED_STAGES}harvest " >> $GITHUB_ENV

      - name: Mark stage ocr
        if: success() && contains(steps.parse-stages.outputs.stages, 'ocr')
        run: echo "LAST_STAGE=ocr" >> $GITHUB_ENV

      - name: Run OCR gate
        if: success() && contains(steps.parse-stages.outputs.stages, 'ocr')
        uses: ./.github/actions/run-gate
        with:
          workflow: ocr-gate.yml
          ref: ${{ github.ref }}
          head-branch: ${{ steps.parse-stages.outputs['head-branch'] }}

      - name: Record OCR completion
        if: success() && contains(steps.parse-stages.outputs.stages, 'ocr')
        run: echo "COMPLETED_STAGES=${COMPLETED_STAGES}ocr " >> $GITHUB_ENV

      - name: Mark stage translate
        if: success() && contains(steps.parse-stages.outputs.stages, 'translate')
        run: echo "LAST_STAGE=translate" >> $GITHUB_ENV

      - name: Run translation gate matrix
        if: success() && contains(steps.parse-stages.outputs.stages, 'translate')
        uses: ./.github/actions/run-gate
        with:
          workflow: translation-gate.yml
          ref: ${{ github.ref }}
          head-branch: ${{ steps.parse-stages.outputs['head-branch'] }}
          inputs-json: >-
            {"batch_size":"${{ env.BATCH_SIZE }}","workers":"${{ env.WORKERS }}"}
          matrix-size: ${{ env.MATRIX_SIZE }}
          matrix-input-name: matrix_index

      - name: Record translation completion
        if: success() && contains(steps.parse-stages.outputs.stages, 'translate')
        run: echo "COMPLETED_STAGES=${COMPLETED_STAGES}translate " >> $GITHUB_ENV

      - name: Mark stage qa
        if: success() && contains(steps.parse-stages.outputs.stages, 'qa')
        run: echo "LAST_STAGE=qa" >> $GITHUB_ENV

      - name: Run QA gate
        if: contains(steps.parse-stages.outputs.stages, 'qa')
        uses: ./.github/actions/run-gate
        with:
          workflow: translation-gate.yml
          ref: ${{ github.ref }}
          head-branch: ${{ steps.parse-stages.outputs['head-branch'] }}

      - name: Record QA completion
        if: contains(steps.parse-stages.outputs.stages, 'qa')
        run: echo "COMPLETED_STAGES=${COMPLETED_STAGES}qa " >> $GITHUB_ENV

      - name: Mark stage figures
        if: success() && contains(steps.parse-stages.outputs.stages, 'figures')
        run: echo "LAST_STAGE=figures" >> $GITHUB_ENV

      - name: Check month for figures
        id: check-month
        if: success() && contains(steps.parse-stages.outputs.stages, 'figures')
        run: |
          if [ -z "${{ env.MONTH }}" ]; then
            echo "⏭️ Skipping figures stage: month input not provided"
            echo "   To run figures, provide month input in YYYYMM format (e.g., 202402)"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "✅ Month for figure processing: ${{ env.MONTH }}"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Run figure gate
        if: success() && contains(steps.parse-stages.outputs.stages, 'figures') && steps.check-month.outputs.skip != 'true'
        uses: ./.github/actions/run-gate
        with:
          workflow: figure-gate.yml
          ref: ${{ github.ref }}
          head-branch: ${{ steps.parse-stages.outputs['head-branch'] }}
          inputs-json: >-
            {"month":"${{ env.MONTH }}","workers":"${{ env.WORKERS }}","figure_concurrent":"8","cs_ai_only":"true"}

      - name: Record figures completion
        if: success() && contains(steps.parse-stages.outputs.stages, 'figures') && steps.check-month.outputs.skip != 'true'
        run: echo "COMPLETED_STAGES=${COMPLETED_STAGES}figures " >> $GITHUB_ENV

      - name: Record figures skipped
        if: success() && contains(steps.parse-stages.outputs.stages, 'figures') && steps.check-month.outputs.skip == 'true'
        run: echo "COMPLETED_STAGES=${COMPLETED_STAGES}figures(skipped) " >> $GITHUB_ENV

      - name: Mark stage render
        if: contains(steps.parse-stages.outputs.stages, 'render')
        run: echo "LAST_STAGE=render" >> $GITHUB_ENV

      - name: Run render gate
        if: contains(steps.parse-stages.outputs.stages, 'render')
        uses: ./.github/actions/run-gate
        with:
          workflow: render-gate.yml
          ref: ${{ github.ref }}
          head-branch: ${{ steps.parse-stages.outputs['head-branch'] }}

      - name: Record render completion
        if: contains(steps.parse-stages.outputs.stages, 'render')
        run: echo "COMPLETED_STAGES=${COMPLETED_STAGES}render " >> $GITHUB_ENV
      - name: Generate pipeline report
        if: always()
        run: |
          echo "Pipeline orchestration complete"
          echo "Stages requested: ${{ steps.parse-stages.outputs.stages }}"
          echo "Matrix size: ${{ github.event.inputs.matrix_size || '3' }}"
          echo "Batch size: ${{ github.event.inputs.batch_size || '100' }}"
          echo "Workers: ${{ github.event.inputs.workers || '20' }}"

      - name: Notify orchestrator failure
        if: failure() && secrets.DISCORD_WEBHOOK_URL != ''
        uses: actions/github-script@v7
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          FAILED_STAGE: ${{ env.LAST_STAGE }}
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            if (!webhook) {
              core.info('No webhook configured; skipping failure notification.');
              return;
            }
            const stage = process.env.FAILED_STAGE || 'unknown stage';
            await fetch(webhook, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content: `❌ Pipeline orchestrator failed at stage: ${stage}` })
            });

      - name: Notify orchestrator success
        if: success() && secrets.DISCORD_WEBHOOK_URL != ''
        uses: actions/github-script@v7
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          COMPLETED: ${{ env.COMPLETED_STAGES }}
          REQUESTED: ${{ steps.parse-stages.outputs.stages }}
        with:
          script: |
            const webhook = process.env.WEBHOOK;
            if (!webhook) {
              core.info('No webhook configured; skipping success notification.');
              return;
            }
            const completed = (process.env.COMPLETED || '').trim() || '(none)';
            const requested = process.env.REQUESTED || '(unspecified)';
            await fetch(webhook, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content: `✅ Pipeline orchestrator finished.\nRequested stages: ${requested}\nCompleted stages: ${completed}` })
            });
