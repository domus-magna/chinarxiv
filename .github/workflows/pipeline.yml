name: Universal Pipeline
# ============================================================================
# PURPOSE: Single workflow that handles ALL translation processing.
#
# This workflow replaces: backfill.yml, batch_translate.yml, daily-pipeline.yml,
# translate-from-b2.yml, complete-paper.yml, and more.
#
# ALL LOGIC IS IN PYTHON (src/orchestrator.py) - THIS YAML IS INTENTIONALLY DUMB.
#
# IMPORTANT: DATABASE IS SOURCE OF TRUTH
# Papers must exist in the PostgreSQL database BEFORE this workflow can process
# them. The orchestrator does NOT harvest/discover new papers automatically.
#
# To add new papers to the database:
#   python scripts/import_to_postgres.py --month YYYYMM
#   OR: python -m src.harvest_chinaxiv_optimized --start YYYYMM --end YYYYMM
#
# USE CASES:
# - Process specific month: --scope month --target 202401
# - Process specific papers: --scope list --target id1,id2
# - Process from file: --scope file --target /path/to/ids.txt
# - Resume pending/zombie: --scope smart-resume (default for scheduled)
# - Force re-process: Add --force flag
#
# ADMIN FLAGS (use sparingly):
# - --text-only: Skip figure translation
# - --figures-only: Skip text translation (assumes text complete)
# ============================================================================

on:
  workflow_dispatch:
    inputs:
      scope:
        type: choice
        description: "What to process"
        required: true
        default: 'smart-resume'
        options:
          - discover       # Discover new papers for a month (no translation)
          - month          # Process all papers from a specific month (YYYYMM)
          - list           # Process specific papers (comma-separated IDs)
          - file           # Process papers from uploaded file
          - smart-resume   # Process pending/zombie papers (default)

      target:
        type: string
        description: "YYYYMM for month, comma-separated IDs for list"
        required: false

      force:
        type: boolean
        default: false
        description: "Force re-process even if complete"

      workers:
        type: string
        default: '10'
        description: "Parallel workers (1-20)"

      text_only:
        type: boolean
        default: false
        description: "[Admin] Skip figure translation"

      figures_only:
        type: boolean
        default: false
        description: "[Admin] Skip text (figures only)"

      dry_run:
        type: boolean
        default: false
        description: "Dry run (no actual processing)"

  schedule:
    # Daily at 3 AM UTC - processes pending and zombie papers
    - cron: '0 3 * * *'

run-name: >-
  pipeline: ${{ inputs.scope || 'smart-resume' }}${{ inputs.target && format(' {0}', inputs.target) || '' }}${{ inputs.force && ' [force]' || '' }}${{ inputs.text_only && ' [text-only]' || '' }}${{ inputs.figures_only && ' [figures-only]' || '' }}

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ghostscript \
            poppler-utils \
            tesseract-ocr \
            tesseract-ocr-chi-sim \
            tesseract-ocr-eng \
            ocrmypdf \
            pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            fonts-noto-cjk

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install awscli

      - name: Preflight - Validate credentials
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          MOONDREAM_API_KEY: ${{ secrets.MOONDREAM_API_KEY }}
          BACKBLAZE_KEY_ID: ${{ secrets.BACKBLAZE_KEY_ID }}
          BACKBLAZE_APPLICATION_KEY: ${{ secrets.BACKBLAZE_APPLICATION_KEY }}
          BRIGHTDATA_API_KEY: ${{ secrets.BRIGHTDATA_API_KEY }}
          BRIGHTDATA_ZONE: ${{ secrets.BRIGHTDATA_ZONE }}
        run: |
          set -e
          errors=0
          SCOPE="${{ inputs.scope || 'smart-resume' }}"

          echo "Checking credentials for scope: $SCOPE"

          # Database always required
          if [ -z "$DATABASE_URL" ]; then
            echo "::error::DATABASE_URL is required"
            errors=1
          fi

          # Discover scope needs BrightData
          if [ "$SCOPE" = "discover" ]; then
            if [ -z "$BRIGHTDATA_API_KEY" ]; then
              echo "::error::BRIGHTDATA_API_KEY is required for discovery"
              errors=1
            fi
            if [ -z "$BRIGHTDATA_ZONE" ]; then
              echo "::error::BRIGHTDATA_ZONE is required for discovery"
              errors=1
            fi
          fi

          # Translation scopes need translation credentials
          if [ "$SCOPE" != "discover" ]; then
            if [ -z "$OPENROUTER_API_KEY" ]; then
              echo "::error::OPENROUTER_API_KEY is required for text translation"
              errors=1
            fi

            # Figure credentials required unless text-only mode
            if [ "${{ inputs.text_only }}" != "true" ]; then
              if [ -z "$GEMINI_API_KEY" ]; then
                echo "::error::GEMINI_API_KEY is required for figure translation (use text_only=true to skip figures)"
                errors=1
              fi
              if [ -z "$MOONDREAM_API_KEY" ]; then
                echo "::error::MOONDREAM_API_KEY is required for figure QA (use text_only=true to skip figures)"
                errors=1
              fi
            fi
          fi

          # B2 always required
          if [ -z "$BACKBLAZE_KEY_ID" ] || [ -z "$BACKBLAZE_APPLICATION_KEY" ]; then
            echo "::error::B2 credentials required for storage"
            errors=1
          fi

          if [ "$errors" -eq 1 ]; then
            exit 1
          fi

          echo "All required credentials present"

      - name: Run Orchestrator
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          MOONDREAM_API_KEY: ${{ secrets.MOONDREAM_API_KEY }}
          BRIGHTDATA_API_KEY: ${{ secrets.BRIGHTDATA_API_KEY }}
          BRIGHTDATA_ZONE: ${{ secrets.BRIGHTDATA_ZONE }}
          BRIGHTDATA_BROWSER_WSS: ${{ secrets.BRIGHTDATA_BROWSER_WSS }}
          AWS_ACCESS_KEY_ID: ${{ secrets.BACKBLAZE_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BACKBLAZE_APPLICATION_KEY }}
          AWS_DEFAULT_REGION: us-west-004
          BACKBLAZE_KEY_ID: ${{ secrets.BACKBLAZE_KEY_ID }}
          BACKBLAZE_APPLICATION_KEY: ${{ secrets.BACKBLAZE_APPLICATION_KEY }}
          BACKBLAZE_S3_ENDPOINT: ${{ secrets.BACKBLAZE_S3_ENDPOINT }}
          BACKBLAZE_BUCKET: ${{ secrets.BACKBLAZE_BUCKET }}
          BACKBLAZE_PREFIX: ${{ secrets.BACKBLAZE_PREFIX }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          # Pass inputs via env vars to prevent command substitution attacks
          # GitHub Actions expressions in double quotes allow $(cmd) execution
          INPUT_SCOPE: ${{ inputs.scope || 'smart-resume' }}
          INPUT_TARGET: ${{ inputs.target }}
          INPUT_WORKERS: ${{ inputs.workers || '10' }}
          INPUT_FORCE: ${{ inputs.force }}
          INPUT_TEXT_ONLY: ${{ inputs.text_only }}
          INPUT_FIGURES_ONLY: ${{ inputs.figures_only }}
          INPUT_DRY_RUN: ${{ inputs.dry_run }}
        run: |
          set -e

          # Validate worker count is a number between 1-20
          # INPUT_WORKERS comes from env (safe from command substitution)
          if ! [[ "$INPUT_WORKERS" =~ ^[0-9]+$ ]] || [ "$INPUT_WORKERS" -lt 1 ] || [ "$INPUT_WORKERS" -gt 20 ]; then
            echo "::error::workers must be a number between 1 and 20 (got: $INPUT_WORKERS)"
            exit 1
          fi

          # Build command using array to avoid eval (prevents quote-escape attacks)
          CMD=(python -m src.orchestrator --scope "$INPUT_SCOPE" --workers "$INPUT_WORKERS")

          if [ -n "$INPUT_TARGET" ]; then
            CMD+=(--target "$INPUT_TARGET")
          fi

          if [ "$INPUT_FORCE" = "true" ]; then
            CMD+=(--force)
          fi

          if [ "$INPUT_TEXT_ONLY" = "true" ]; then
            CMD+=(--text-only)
          fi

          if [ "$INPUT_FIGURES_ONLY" = "true" ]; then
            CMD+=(--figures-only)
          fi

          if [ "$INPUT_DRY_RUN" = "true" ]; then
            CMD+=(--dry-run)
          fi

          echo "Running: ${CMD[*]}"
          "${CMD[@]}"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-results-${{ github.run_id }}
          path: |
            data/translated/*.json
            data/flagged/*.json
            reports/*.json
          if-no-files-found: ignore
          retention-days: 30
